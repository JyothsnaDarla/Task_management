{% extends 'base.html' %}
{% block content %}

<!-- Search & Filters -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-list-task"></i> Your Tasks</h4>
  <form class="d-flex" method="get" action="{{ url_for('index') }}">
    <input class="form-control me-2" type="search" name="q" value="{{ q }}" placeholder="Search title/description">
    <select class="form-select me-2" name="status">
      <option value="">All statuses</option>
      {% for s in ['Pending','In Progress','Completed'] %}
      <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <select class="form-select me-2" name="sort">
      <option value="due_date" {% if sort=='due_date' %}selected{% endif %}>Sort by due date</option>
      <option value="created_at" {% if sort=='created_at' %}selected{% endif %}>Sort by created</option>
      <option value="priority" {% if sort=='priority' %}selected{% endif %}>Sort by priority</option>
    </select>
    <button class="btn btn-primary" type="submit"><i class="bi bi-funnel"></i> Apply</button>
  </form>
</div>

<!-- Quick Add Form -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form class="row g-2" method="post" action="{{ url_for('quick_add') }}">
      {{ form.csrf_token }}
      <div class="col-md-4">
        {{ form.title(class_="form-control", placeholder="Quick add: Title") }}
      </div>
      <div class="col-md-6">
        {{ form.description(class_="form-control", placeholder="Description (optional)") }}
      </div>
      <div class="col-md-2 d-grid">
        {{ form.submit(class_="btn btn-success") }}
      </div>
    </form>
  </div>
</div>

<!-- Task List -->
{% if tasks|length == 0 %}
  <div class="text-center text-muted py-5">
    <p><i class="bi bi-emoji-frown"></i> No tasks yet. Create one to get started.</p>
  </div>
{% else %}
  <div class="row row-cols-1 row-cols-md-2 g-3">
    {% for task in tasks %}
      <div class="col">
        <div class="card shadow-sm task-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1">{{ task.title }}</h5>
                <p class="text-muted mb-2 small">
                  <i class="bi bi-clock-history"></i> Created {{ task.created_at.strftime('%d %b %Y, %H:%M') }}
                </p>
              </div>
              <span class="badge bg-{{ 'success' if task.status=='Completed' else ('warning' if task.status=='In Progress' else 'secondary') }}">
                {{ task.status }}
              </span>
            </div>
            {% if task.description %}
              <details class="mt-2">
                <summary class="text-primary">Show details</summary>
                <p class="card-text mt-2">{{ task.description }}</p>
              </details>
            {% endif %}
            <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
              <span class="badge text-bg-light"><i class="bi bi-calendar-event"></i> Due: {{ task.due_badge() }}</span>
              <span class="badge text-bg-{{ 'danger' if task.priority==3 else ('primary' if task.priority==2 else 'secondary') }}">
                <i class="bi bi-flag"></i> Priority: {{ 'High' if task.priority==3 else ('Medium' if task.priority==2 else 'Low') }}
              </span>
            </div>
          </div>
          <div class="card-footer d-flex gap-2">
            <form method="post" action="{{ url_for('toggle_status', task_id=task.id) }}">
              {{ form.csrf_token }}
              <button class="btn btn-outline-success btn-sm" type="submit">
                {% if task.status!='Completed' %}
                  <i class="bi bi-check-circle"></i> Mark completed
                {% else %}
                  <i class="bi bi-arrow-counterclockwise"></i> Mark pending
                {% endif %}
              </button>
            </form>
            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-pencil-square"></i> Edit
            </a>
            <!-- Delete button triggers modal -->
            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ task.id }}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="deleteModal{{ task.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirm Delete</h5></div>
            <div class="modal-body">Are you sure you want to delete "{{ task.title }}"?</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <form method="post" action="{{ url_for('delete_task', task_id=task.id) }}">
                {{ form.csrf_token }}
                <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Auto-dismiss Toasts -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.toast').forEach(toastEl => {
      new bootstrap.Toast(toastEl, { delay: 3000 }).show();
    });
  });
</script>

{% endblock %}
